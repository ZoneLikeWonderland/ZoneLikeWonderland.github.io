---
layout: post
title: 清华第23届智能体大赛总结 
categories: [agent]
description: 寻路&躲避弹道 
keywords: 清华, 智能体
---

[八强AI源码](https://github.com/ZoneLikeWonderland/AI-For-DoorKickers-)
原本打算采用[分层状态机](https://www.zhihu.com/question/21090429)或Q-learning实现，但是懒得实现了
于是程序只剩下寻路和躲避弹道

# 算法 #
## 寻路 ##
地图如下，黑色为可行区域：
![黑色为可行区域](/images/blog/map.bmp)
本AI原本考虑采用A*，但是有如下两个缺点：
#### 速度慢 ####
++此游戏地图为320*320网格，两点之间最少搜索步数也等于其曼哈顿距离。++
对于此地图可以缩减地图尺寸来减少搜索步数，而且对最终路径影响不大。
#### 路径不平滑 ####
++因为A*搜索为4方向或者8方向，最后的路径只能为阶梯状。++
对于该问题，使路径平衡可以参考[A*寻路 -- 更加真实 的路径（二）](https://blog.csdn.net/geniicheng222/article/details/84272036)。

不局限于网格A*的话，还可以考虑的寻路算法有：

1. WayPoint 
2. NavMesh 

这两种方法的介绍：[Nav导航网格寻路](https://blog.csdn.net/ynnmnm/article/details/44833007)
其中WayPoint方法在地图中散布路径点，转化为无向图寻路；NavMesh切割可行区域为凸多边形，路径转折点必为多边形顶点。
由于我不确定怎么挑选路径点为最优，并且考虑到地图以后会改变（想多了，早知道打表了），而地图中也不存在整块的较为规则的凸多边形，要预处理多边形也很麻烦，所以最终实现如下：

1. 缩减原始地图尺寸至二分之一（为了减少路径点数量，最终约为1500个）
2. 选取所有墙的凸顶点为路径点
3. 计算所有路径点通断性和距离，建立邻接表

然后变成了一张无向图，可以继续用A* 了，搜索步数基本在10以内。
由于路径点比较多，并且计算通断性较慢，复杂度O(320 * n^2)，实际测试的时候大约需要5帧（250ms）完成预处理，而服务器每帧限时50ms。于是就开一个thread然后detach掉，前几帧没初始化好之前先用原来那个劣质A*顶上。
> 后来线下听清华同学说，对于初始化可以：
> 1. 编译前打表（然而源码上传有大小限制）
> 2. **编译时打表**
>
> 并且可以随机散布路径点，并且500个就可以了貌似。

## 躲避弹道 ##
![](/images/blog/geogebra-export.png)
考虑A点为人物当前点，B点为火球当前点，BD方向为火球行进方向。
两条红线g、h为计算出的火球行进路径边界，根据人物速度与火球速度计算出人物与火球行进路径边界（红线）的交点G、H。则为避免与火球接触，人物可行行进方向在AG逆时针方向与AH顺时针方向。最后选取与预定行进方向夹角最小的可行行进方向。
多个火球来临时，如上计算。当不存在能完全躲避的情况时，选取处于最少火球行进路径上的方向。